# Kangaroo Hopping ‚Äì Direct-Collocation Predictive Simulation (MATLAB + CasADi)

This repository contains MATLAB code for a **predictive simulation of a hopping kangaroo** (template also suitable for a ‚Äúhopping robot‚Äù). The motion is generated by solving a **trajectory optimization** problem with **direct collocation** (backward Euler scheme) using **CasADi**‚Äôs Opti stack and the **IPOPT** nonlinear solver.

The formulation closely follows the five-link examples in:  
Kelly, *An Introduction to Trajectory Optimization: How to Do Your Own Direct Collocation*, **SIAM Review** (2017).

---

## Key Features

- **Physics-based model**: pelvis + three-segment leg (femur, tibia, foot/toes), configurable masses, inertias, lengths, and a **toe‚Äìfemur elastic element** (spring) with damping.
- **Contact & GRFs**: ground reaction forces (Fx, Fy) activated only when the toe is on the ground.
- **Optimization objective**: minimize squared joint torques (hip, knee, ankle, MTP) with optional regularization on angular accelerations.
- **Gait environments**: Earth, Moon, Mars (changes gravity `g`).
- **Periodicity & speed**: enforces periodic state/motion and average stride length.
- **Outputs**: animation, generalized coordinates, GRFs, and joint torques.

---

This code is currently being updated and may not work in all cases. If it does work is should produce an animation like this.

![animation](https://github.com/user-attachments/assets/b8e15491-ac67-4ac3-9d8f-c32a6af7c3dc)

---

## Quick Start

### Requirements
- MATLAB (tested with R2016a+)
- [CasADi](https://web.casadi.org/) (tested with 3.5.5 for MATLAB)
- IPOPT binaries (bundled within CasADi distributions for MATLAB)

### Setup
1. Clone/download this repo.
2. Install CasADi for MATLAB and note its path.
3. In the main script, update the `addpath` line to point to your CasADi install, e.g.:
   ```matlab
   addpath('C:\path\to\casadi-windows-matlabR2016a-v3.5.5')
   ```
4. Open MATLAB in the repo folder and run the main script.

### Run
```matlab
clear; close all; clc;
% Run the main file (e.g., main.m unless you rename it)
```

The solver will compute an optimal periodic hop and then:
- render an **animation**, and
- produce plots for **coordinates**, **ground reaction forces**, and **joint torques**.

---

## What the Code Does (High Level)

1. **Define model & cost**
   - Segments: pelvis (`p`), femur (`f`), tibia (`t`), foot/toes (`m`).
   - Parameters: masses (`mp, mf, mt, mm`), inertias (`Ip, If, It, Im`), lengths (`lp, lf, lt, lm`), spring geometry (`ls, lc, lso`) and stiffness `ks`, damping `c`.
   - **Cost**:
   - 
     J = ‚à´ ( w‚ÇÅ T<sub>hip</sub>¬≤ + w‚ÇÇ T<sub>knee</sub>¬≤ + w‚ÇÉ T<sub>ankle</sub>¬≤ + w‚ÇÑ T<sub>mtp</sub>¬≤ ) dt  
+ (small acceleration regularization)
  
     Weights `w1..w4` are editable.

2. **Choose environment & mesh**
   - `selected_gait`: `'nominal' | 'on_the_moon' | 'on_mars'` ‚Üí sets gravity `g`.
   - Number of intervals `N` (default 100), stride time `T` (0.3 s, currently fixed), stride length `L` (0.5 m).

3. **Decision variables**
   - States at each mesh node \(k\):  
     horizontal & vertical toe position `(xt, yt)`, pelvis/femur/tibia/foot angles `(tp, tf, tt, tm)`, and their velocities.  
   - Controls at each interval: corresponding accelerations plus joint torques `(Th, Tk, Ta, Tt)` and GRFs `(Fx, Fy)`.

4. **Dynamics & constraints**
   - **Backward Euler collocation** via `eulerIntegrator(...)`.
   - **Implicit multibody dynamics** equality via `getModelConstraintErrors(...)` (enforces equations of motion).
   - **Contact logic**: GRFs can act only at ground contact (`yt * Fx = 0`, `yt * Fy = 0`).
   - **Friction-like coupling**: `Fx - 100 * dxt * Fy = 0` (simple constraint to relate shear force to fore-aft velocity).
   - **Kinematic bounds**: joint limits; knee no hyperextension (`0 <= tf - tt <= pi`).
   - **Torque-rate limits** to improve numerical stability.
   - **Flight/contact window**: piecewise conditions on `yt` enforce take-off/flight/landing phases.
   - **Periodicity**: start and end states/velocities match; stride length meets `xt(end) - xt(1) = L`.

5. **Solve**
   - Problem solved with IPOPT via `opti.solver('ipopt', optionssol)`; reasonable tolerances and ‚Äúacceptable‚Äù early-exit settings provided.

6. **Post-processing**
   - Extract optimal trajectories and torques.
   - **Animation** using `generateAnimation(...)`.
   - Plots for state trajectories, GRFs, and joint torques.

---

## Repository Structure

```
.
‚îú‚îÄ kangaroo_hop_main.m           % the script you pasted here
‚îú‚îÄ eulerIntegrator.m             % backward Euler residuals for collocation
‚îú‚îÄ getModelConstraintErrors.m    % returns implicit dynamics residuals f(q,dq,ddq,T,F)=0
‚îú‚îÄ getJointPositions.m           % forward kinematics for animation
‚îú‚îÄ generateAnimation.m           % simple line-figure animator
‚îî‚îÄ /casadi-.../                  % your CasADi install (external)
```

---

## Model Parameters You Can Tweak

Inside the script, look for:

- **Weights** (cost function):  
  ```matlab
  w1 = 1; % hip
  w2 = 1; % knee
  w3 = 1; % ankle
  w4 = 1; % toes
  ```
- **Environment**:  
  ```matlab
  selected_gait = 'nominal'; % 'on_the_moon' | 'on_mars'
  ```
- **Geometry & mass** (includes a commented **27 kg kangaroo** set):  
  ```matlab
  % Default (toy) values...
  % ... or uncomment "27 kg kangaroo" block for more realistic scaling
  ```
- **Spring‚Äìdamper**: `ks`, `lso`, `ls`, `lc`, `c`
- **Stride & mesh**: `N`, `T` (fixed to 0.3 s in code), `L` (stride length)

**Tip:** If solutions are jittery or over-damped, adjust `c` (damping) and `ks` (spring stiffness), or relax torque-rate constraints slightly.

---

## Output & Visualization

- **Animation**: toggle with `generate_animation = true/false;`
- **Figures**: toggle with `generate_plots = true/false;`

Plots produced:
- Generalized coordinates: `x_T(t), y_T(t), tp(t), tf(t), tt(t), tm(t)`
- GRFs: `F_x(t), F_y(t)`
- Joint torques: `T_hip(t), T_knee(t), T_ankle(t), T_mtp(t)`

---

## Tips for Robust Solves

- **Initial guesses matter**: The script seeds states and velocities with simple ramps/plateaus. If the solver struggles, try:
  - Smaller torque-rate limits (or temporarily remove),  
  - Slightly relax bounds on `yt` during flight,  
  - Reduce `N` (fewer intervals) to find a coarse solution, then increase.
- **Convergence checks**: Decrease `dt = T/N` (increase `N`) and verify trajectories/torques don‚Äôt change materially ‚Üí mesh convergence.
- **Infeasible?** Loosen tolerances in `optionssol.ipopt.*` (already set to moderately permissive) or widen variable bounds.

---

## Citing / Acknowledgements

If you use this code, please cite:

- Kelly, M. *An Introduction to Trajectory Optimization: How to Do Your Own Direct Collocation*. **SIAM Review** (2017).
- CasADi: Andersson et al., *CasADi ‚Äì A software framework for nonlinear optimization and optimal control*, **Math. Prog. Comp.** (2019).
- IPOPT: W√§chter & Biegler, *On the Implementation of a Primal-Dual Interior Point Filter Line Search Algorithm for Large-Scale Nonlinear Programming*, **Math. Prog.** (2006).

**Authors:** Friedl De Groote, Christofer J. Clemente, Robin Maag

---

## License

Choose a license (e.g., MIT) and place it in `LICENSE`.

---

## Roadmap (Ideas)

- Multi-leg / two-leg hopping
- More realistic ground contact (Coulomb cone + complementarity)
- Energetics/cost-of-transport objective
- Parameter identification vs. experimental GRFs/kinematics
- Export to CSV/JSON for downstream analysis

---

## FAQ

**Q: MATLAB can‚Äôt find CasADi or `import casadi.*` fails.**  
A: Update the `addpath` to your CasADi folder and ensure it matches your MATLAB version.

**Q: IPOPT fails or returns ‚Äúinfeasible‚Äù**  
A: Try loosening bounds, relaxing torque-rate constraints, or using simpler initial guesses. Then re-tighten once a solution is found.

**Q: Animation looks wrong / segments cross**  
A: Check `getJointPositions.m` forward kinematics match the segment definitions and sign conventions used in dynamics.

---

Happy hopping! ü¶ò
